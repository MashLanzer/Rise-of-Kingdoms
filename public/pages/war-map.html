<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Mapa de Guerra Interactivo - Planifica tus ataques y estrategias en el Reino Perdido (KvK)">
    <title>Mapa de Guerra - Academy Rise of Kingdoms</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <div class="loading">
        <div class="loading-spinner"></div>
    </div>
    <div class="particles"></div>

    <header>
        <div class="header-container">
            <a href="../index.html" class="logo">
                Rise of Kingdoms
            </a>

            <div class="event-ticker" id="eventTicker">
                <div class="ticker-content" id="tickerItems">
                    <span class="ticker-item"><span class="event-dot live"></span> KvK S4: Mapa Abierto</span>
                    <span class="ticker-item"><span class="event-dot live"></span> Kingsland: Pr√≥ximamente</span>
                </div>
            </div>

            <button class="search-btn" id="globalSearchBtn">üîç Buscar</button>
            <button class="theme-toggle" id="themeToggle">üåô</button>
            <button class="sound-toggle" id="soundToggle">üîä</button>

            <nav>
                <ul class="nav-menu">
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="comandantes.html">Comandantes</a></li>
                    <li><a href="war-map.html" class="active">Mapa de Guerra</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="section-header">
                <h1>üó∫Ô∏è Mapa de Guerra Interactivo</h1>
                <p>Planifica ofensivas coordinadas, marca objetivos estrat√©gicos y dise√±a la victoria en el Reino
                    Perdido.</p>
            </div>

            <div class="war-map-wrapper">
                <div class="map-controls">
                    <div class="control-group">
                        <label>Herramientas T√°cticas</label>
                        <div class="btn-group">
                            <button class="map-tool active" data-tool="move" title="Mover">‚úã</button>
                            <button class="map-tool" data-tool="city" title="Ciudad">üè∞</button>
                            <button class="map-tool" data-tool="flag" title="Bandera">üö©</button>
                            <button class="map-tool" data-tool="arrow" title="Flecha de Ataque">üèπ</button>
                            <button class="map-tool" data-tool="pass" title="Paso">‚õ∞Ô∏è</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Color de Facci√≥n</label>
                        <div class="color-presets">
                            <div class="color-swatch active" style="background: var(--gold-primary);"
                                data-color="#d4af37"></div>
                            <div class="color-swatch" style="background: #ff4d4d;" data-color="#ff4d4d"></div>
                            <div class="color-swatch" style="background: #4d79ff;" data-color="#4d79ff"></div>
                            <div class="color-swatch" style="background: #4dff88;" data-color="#4dff88"></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-secondary w-100" id="clearMap">Borrar Todo</button>
                        <button class="btn btn-primary w-100 mt-1" id="saveMap">Guardar Estrategia</button>
                    </div>
                </div>

                <div class="map-canvas-container" id="mapWindow">
                    <canvas id="warMapCanvas"></canvas>
                    <div class="map-grid-overlay"></div>
                    <div class="map-coordinates">X: 000 | Y: 000</div>
                </div>
            </div>

            <div class="card mt-2">
                <h3>üìñ Manual de Operaciones</h3>
                <p>1. Selecciona una <strong>Facci√≥n</strong> para tus marcas t√°cticas.</p>
                <p>2. Usa las <strong>Flechas</strong> para indicar direcciones de marcha y flanqueo.</p>
                <p>3. Marca los <strong>Puntos de Control</strong> (Pasos y Estructuras) para coordinar el tiempo de
                    llegada.</p>
                <p>Nota: Este simulador es puramente estrat√©gico y visual para coordinaci√≥n interna de alianzas.</p>
            </div>
        </div>
    </main>

    <footer>
        <p>Academy Rise of Kingdoms ‚Ä¢ Centro de Mando T√°ctico</p>
    </footer>

    <script src="../js/search.js"></script>
    <script src="../js/script.js"></script>
    <script>
        // L√≥gica espec√≠fica del mapa de guerra
        const canvas = document.getElementById('warMapCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('mapWindow');

        let isDrawing = false;
        let startX, startY;
        let currentTool = 'move';
        let currentColor = '#d4af37';
        let elements = [];

        function initMap() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Listeners de controles
            document.querySelectorAll('.map-tool').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.map-tool.active').classList.remove('active');
                    btn.classList.add('active');
                    currentTool = btn.dataset.tool;
                });
            });

            document.querySelectorAll('.color-swatch').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.color-swatch.active').classList.remove('active');
                    btn.classList.add('active');
                    currentColor = btn.dataset.color;
                });
            });

            document.getElementById('clearMap').addEventListener('click', () => {
                elements = [];
                draw();
            });

            canvas.addEventListener('mousedown', startInteract);
            canvas.addEventListener('mousemove', interact);
            canvas.addEventListener('mouseup', stopInteract);

            // Dibujar fondo inicial
            draw();
        }

        function resizeCanvas() {
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            draw();
        }

        function startInteract(e) {
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;

            if (currentTool !== 'move' && currentTool !== 'arrow') {
                elements.push({
                    type: currentTool,
                    x: startX,
                    y: startY,
                    color: currentColor
                });
                draw();
            }
        }

        function interact(e) {
            const rect = canvas.getBoundingClientRect();
            const currX = e.clientX - rect.left;
            const currY = e.clientY - rect.top;

            // Actualizar coordenadas
            document.querySelector('.map-coordinates').innerText = `X: ${Math.floor(currX)} | Y: ${Math.floor(currY)}`;

            if (isDrawing && currentTool === 'arrow') {
                draw();
                drawArrow(startX, startY, currX, currY, currentColor);
            }
        }

        function stopInteract(e) {
            if (isDrawing && currentTool === 'arrow') {
                const rect = canvas.getBoundingClientRect();
                elements.push({
                    type: 'arrow',
                    x1: startX,
                    y1: startY,
                    x2: e.clientX - rect.left,
                    y2: e.clientY - rect.top,
                    color: currentColor
                });
            }
            isDrawing = false;
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar fondo t√°ctico (simulado)
            ctx.fillStyle = '#0a0d14';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibujar elementos guardados
            elements.forEach(el => {
                ctx.fillStyle = el.color;
                ctx.strokeStyle = el.color;
                ctx.lineWidth = 3;

                if (el.type === 'city') {
                    ctx.font = '24px serif';
                    ctx.fillText('üè∞', el.x - 12, el.y + 12);
                } else if (el.type === 'flag') {
                    ctx.font = '24px serif';
                    ctx.fillText('üö©', el.x - 12, el.y + 12);
                } else if (el.type === 'pass') {
                    ctx.font = '24px serif';
                    ctx.fillText('‚õ∞Ô∏è', el.x - 12, el.y + 12);
                } else if (el.type === 'arrow') {
                    drawArrow(el.x1, el.y1, el.x2, el.y2, el.color);
                }
            });
        }

        function drawArrow(fromx, fromy, tox, toy, color) {
            var headlen = 15;
            var dx = tox - fromx;
            var dy = toy - fromy;
            var angle = Math.atan2(dy, dx);

            ctx.beginPath();
            ctx.moveTo(fromx, fromy);
            ctx.lineTo(tox, toy);
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }

        initMap();
    </script>
</body>

</html>